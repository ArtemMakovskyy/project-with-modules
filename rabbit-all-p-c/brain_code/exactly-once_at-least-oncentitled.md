exactly-once / at-least-once
# ๐ง 1๏ธโฃ ะะฐะทะพะฒัะต ะฟะพะฝััะธั (ะพัะตะฝั ะฒะฐะถะฝะพ)

## ๐น At-most-once

> _ยซ0 ะธะปะธ 1 ัะฐะทยป_

- ัะพะพะฑัะตะฝะธะต **ะผะพะถะตั ะฟะพัะตัััััั**
    
- **ะดัะฑะปะธะบะฐัะพะฒ ะฝะตั**
    
- ัะตะดะบะพ ะธัะฟะพะปัะทัะตััั
    

---

## ๐น At-least-once โ (ััะฐะฝะดะฐัั RabbitMQ)

> _ยซ1 ะธะปะธ ะฑะพะปััะต ัะฐะทยป_

- ัะพะพะฑัะตะฝะธะต **ะฝะต ะฟะพัะตััะตััั**
    
- **ะดัะฑะปะธะบะฐัั ะฒะพะทะผะพะถะฝั**
    
- **ะะะะะฌะะ ะดะพััะธะถะธะผะพ**
    

---

## ๐น Exactly-once โ (ะฒ RabbitMQ)

> _ยซัะพะฒะฝะพ 1 ัะฐะทยป_

- **ัะตะพัะตัะธัะตัะบะธ ะบัะฐัะธะฒะพ**
    
- **ะฟัะฐะบัะธัะตัะบะธ ะฝะตะฒะพะทะผะพะถะฝะพ** ะฒ ัะฐัะฟัะตะดะตะปัะฝะฝัั ัะธััะตะผะฐั
    
- RabbitMQ **ะะ ะณะฐัะฐะฝัะธััะตั**
    

---

# ๐งฉ 2๏ธโฃ At-least-once ะฒ RabbitMQ (ะบะฐะบ ััะพ ัะฐะฑะพัะฐะตั)

### ะกัะตะฝะฐัะธะน

`Producer โ Exchange โ Queue โ Consumer`

### Consumer ั manual ack

@RabbitListener(queues = "q.order", ackMode = "MANUAL")
public void handle(
        String msg,
        Channel channel,
        @Header(AmqpHeaders.DELIVERY_TAG) long tag
) throws Exception {

    process(msg);           // ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ
    channel.basicAck(tag, false);
}


---

### ะงัะพ ะฟัะพะธััะพะดะธั, ะตัะปะธ consumer ัะฟะฐะป?

|ะะพะผะตะฝั ะฟะฐะดะตะฝะธั|ะงัะพ ะฑัะดะตั|
|---|---|
|ะะ `basicAck`|ัะพะพะฑัะตะฝะธะต **ะฒะตัะฝัััั ะฒ ะพัะตัะตะดั**|
|ะะะกะะ `basicAck`|ัะพะพะฑัะตะฝะธะต ััะธัะฐะตััั ะพะฑัะฐะฑะพัะฐะฝะฝัะผ|

๐ ะะพััะพะผั:

> RabbitMQ ะณะฐัะฐะฝัะธััะตั **ะดะพััะฐะฒะบั**,  
> ะฝะพ **ะะ ะณะฐัะฐะฝัะธััะตั ะพััััััะฒะธะต ะดัะฑะปะธะบะฐัะพะฒ**.

---

## โ ะัะธะผะตั ะดัะฑะปะธะบะฐัะฐ

Consumer ะฟะพะปััะธะป ัะพะพะฑัะตะฝะธะต
โ
ะกะพััะฐะฝะธะป ะฒ ะะ
โ
ะฃะฟะฐะป ะะ ack
โ
RabbitMQ ะพัะฟัะฐะฒะธะป ัะพะพะฑัะตะฝะธะต ัะฝะพะฒะฐ
โ
Consumer ะพะฑัะฐะฑะพัะฐะป ะฟะพะฒัะพัะฝะพ โ


โก **ะัะฑะปะธะบะฐั**

---

# ๐ง 3๏ธโฃ Exactly-once โ ะฟะพัะตะผั ััะพ ะฝะตะฒะพะทะผะพะถะฝะพ

ะงัะพะฑั ะฑัะปะพ exactly-once, ะฝัะถะฝะพ:

- ัะพััะฐะฝะธัั ะดะฐะฝะฝัะต
    
- ะพัะฟัะฐะฒะธัั ack
    
- **ะฐัะพะผะฐัะฝะพ** ะธ **ัะฐัะฟัะตะดะตะปัะฝะฝะพ**
    

ะะพ:

- ัะตัั ะผะพะถะตั ะพะฑะพัะฒะฐัััั
    
- consumer ะผะพะถะตั ัะฟะฐััั
    
- broker ะผะพะถะตั ะฟะตัะตะทะฐะฟัััะธัััั
    

๐ **ะะตั ัะฟะพัะพะฑะฐ ะฟะพะฝััั**,  
ะฟัะพะธะทะพััะป ะปะธ ack _ะฟะพัะปะต_ ะฑะธะทะฝะตั-ะพะฟะตัะฐัะธะธ ะธะปะธ _ะดะพ_.

> ะญัะพ ััะฝะดะฐะผะตะฝัะฐะปัะฝะพะต ะพะณัะฐะฝะธัะตะฝะธะต ัะฐัะฟัะตะดะตะปัะฝะฝัั ัะธััะตะผ.

---

# ๐งฉ 4๏ธโฃ ะะฐะบ ะถะธัั ะฑะตะท exactly-once (ะะะะะะะฌะะ)

## โ ะะตะปะฐัั **idempotent consumer**

> ะะพะฒัะพัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ **ะฝะต ะปะพะผะฐะตั ัะธััะตะผั**

---

### ๐น ะกะฟะพัะพะฑ 1: Idempotency key (ะปัััะธะน)

{
  "eventId": "123e4567",
  "orderId": 42
}


Consumer:

if (processedEventRepository.exists(eventId)) {
    return; // ัะถะต ะพะฑัะฐะฑะพัะฐะฝะพ
}

processBusinessLogic();
processedEventRepository.save(eventId);


---

### ๐น ะกะฟะพัะพะฑ 2: Unique constraint ะฒ ะะ

`UNIQUE(order_id)`

ะะพะฒัะพัะฝะฐั ะฒััะฐะฒะบะฐ โ exception โ safe ignore

---

### ๐น ะกะฟะพัะพะฑ 3: UPSERT

`INSERT ... ON CONFLICT DO NOTHING`

---

# ๐งช 5๏ธโฃ ะกัะฐะฒะฝะตะฝะธะต ัััะฐัะตะณะธะน

|ะะฐัะฐะฝัะธั|ะะพัะตัั|ะัะฑะปะธะบะฐัั|ะะตะฐะปัะฝะพััั|
|---|---|---|---|
|at-most-once|โ|โ|โ ัะตะดะบะพ|
|at-least-once|โ|โ|โ RabbitMQ|
|exactly-once|โ|โ|โ ะผะธั|

---

# โ๏ธ 6๏ธโฃ ะะฐะบ ะฒัะณะปัะดะธั PRODUCTION-ะบะพะฝัะธะณ RabbitMQ

### Producer

- persistent messages
    

### Queue

- durable
    
- DLQ
    

### Consumer

- manual ack
    
- idempotent logic
    
- retries + DLQ
    

๐ **ะญัะพ ะธ ะตััั ะฟัะฐะฒะธะปัะฝัะน production-ะฟะฐััะตัะฝ**

---

# ๐ง 7๏ธโฃ ะัะตะฝั ะฒะฐะถะฝะฐั ัะพัะผัะปะฐ (ะทะฐะฟะพะผะฝะธัั)

> **RabbitMQ = at-least-once delivery**  
> **Idempotent consumer = exactly-once EFFECT**

---

# ๐ ะะพัะพัะบะธะน ะฟัะธะผะตั ะธะท ะถะธะทะฝะธ

> ยซะกะฟะธัะฐัั ะดะตะฝัะณะธ ั ะบะฐัััยป

โ exactly-once  
โ at-least-once + ะฟัะพะฒะตัะบะฐ `paymentId`